<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/HarbergerAds.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> HarbergerAds.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">36.54% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>19/52</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">7.14% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>2/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>9/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">35.85% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>19/53</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
import 'zeppelin-solidity/contracts/ownership/Ownable.sol';
import 'zeppelin-solidity/contracts/token/ERC20/ERC20.sol';
&nbsp;
contract HarbergerAds is Ownable {
    // Per day tax rate
    uint256 public taxNumerator;
    uint256 public taxDenominator;
&nbsp;
    ERC20 public erc20;
&nbsp;
    struct Property {
        address taxRecipient;
        address owner;
        uint256 price;
        uint256 paidThru;
    }
&nbsp;
    Property[] public properties;
&nbsp;
    constructor(
        ERC20 erc20Address,
        uint256 _taxNumerator,
        uint256 _taxDenominator
    ) public {
        taxNumerator = _taxNumerator;
        taxDenominator = _taxDenominator;
        erc20 = erc20Address;
    }
&nbsp;
    function taxesDue(uint256 id) public view returns (uint256) {
        Property storage p = properties[id];
&nbsp;
<span class="cstat-no" title="statement not covered" >        return p.price * (now - p.paidThru) * taxNumerator</span>
            / taxDenominator / 1 days;
    }
&nbsp;
    function balanceOf(address user) public constant returns (uint256) {
        uint256 balance = erc20.balanceOf(user);
        uint256 allowance = erc20.allowance(user, this);
        <span class="missing-if-branch" title="if path not taken" >I</span>if (balance &gt; allowance) {
<span class="cstat-no" title="statement not covered" >            return allowance;</span>
        } else {
            return balance;
        }
    }
&nbsp;
    event Change(uint256 indexed id, address indexed to, address indexed from, uint256 price);
    event ChangeRecipient(uint256 indexed id, address indexed to, address indexed from);
    event TaxesPaid(uint256 indexed id, address owner, uint256 paid);
&nbsp;
    function addProperty(uint256 price) public {
        Property memory p;
        p.owner = msg.sender;
        p.taxRecipient = msg.sender;
        p.price = price;
        uint256 id = properties.push(p) - 1;
        emit Change(id, msg.sender, 0, price);
    }
&nbsp;
    // Possibly foreclose on property[id]
    function forecloseIfPossible(uint256 id) public {
        Property storage p = properties[id];
        // Owner must be broke and behind on taxes to foreclose
<span class="cstat-no" title="statement not covered" >        if (p.owner != p.taxRecipient &amp;&amp; balanceOf(p.owner) == 0 &amp;&amp; p.paidThru &lt; now &amp;&amp; p.price &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >            emit Change(id, 0, p.owner, 0);</span>
            delete(properties[id]);
        }
    }
&nbsp;
    // Collect taxes due from account.
    // Return true if taxes fully paid, false otherwise
    function collectTaxes(uint256 id) public returns (bool) {
        Property storage p = properties[id];
<span class="cstat-no" title="statement not covered" >        if (p.owner == p.taxRecipient) {</span>
<span class="cstat-no" title="statement not covered" >            p.paidThru = uint256(now)</span>;
<span class="cstat-no" title="statement not covered" >            return true;</span>
        }
<span class="cstat-no" title="statement not covered" >        uint256 balance = balanceOf(p.owner);</span>
<span class="cstat-no" title="statement not covered" >        uint256 taxes = taxesDue(id);</span>
<span class="cstat-no" title="statement not covered" >        if (taxes &lt;= balance) {</span>
<span class="cstat-no" title="statement not covered" >            p.paidThru = uint256(now)</span>;
<span class="cstat-no" title="statement not covered" >            if (taxes &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >                require(erc20.transferFrom(p.owner, p.taxRecipient, taxes), 'transferFrom failed')</span>;
            }
<span class="cstat-no" title="statement not covered" >            emit TaxesPaid(id, p.owner, taxes);</span>
<span class="cstat-no" title="statement not covered" >            return true;</span>
        } else {
            // Adjust paidThru proportionally (overflow check unnecessary)
<span class="cstat-no" title="statement not covered" >            p.paidThru += uint256((now - p.paidThru) * balance / taxes)</span>;
&nbsp;
            // Collect entire balance for partially-paid taxes
<span class="cstat-no" title="statement not covered" >            if (balance &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >                require(erc20.transferFrom(p.owner, p.taxRecipient, balance), 'transferFrom failed')</span>;
            }
<span class="cstat-no" title="statement not covered" >            emit TaxesPaid(id, p.owner, balance);</span>
<span class="cstat-no" title="statement not covered" >            return false;</span>
        }
    }
&nbsp;
    // Try to buy property for no more than 'max'
    function buy(
        uint256 id,
        uint256 max,
        uint256 price
    )
        public
    {
        Property storage p = properties[id];
&nbsp;
        // Collect taxes from property's owner and possibly foreclose on property[id].
<span class="cstat-no" title="statement not covered" >        collectTaxes(id)</span>;
&nbsp;
        // Foreclosure may change price and seller.
<span class="cstat-no" title="statement not covered" >        forecloseIfPossible(id)</span>;
<span class="cstat-no" title="statement not covered" >        address seller = p.owner;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (seller != msg.sender) {</span>
<span class="cstat-no" title="statement not covered" >            require(max &gt;= p.price, "price is too high")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >            require(balanceOf(msg.sender) &gt;= p.price,</span>
                "insufficient funds");
&nbsp;
            // Transfer purchase price
<span class="cstat-no" title="statement not covered" >            if (p.price &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >                require(erc20.transferFrom(p.owner, seller, p.price), 'transferFrom failed')</span>;
            }
<span class="cstat-no" title="statement not covered" >            p.owner = msg.sender</span>;
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        p.price = price</span>;
<span class="cstat-no" title="statement not covered" >        emit Change(id, msg.sender, seller, price);</span>
    }
&nbsp;
    function propertyCount() public view returns (uint256) {
        return properties.length;
    }
&nbsp;
    function changeRecipient(uint256 id, address newRecipient) public {
        <span class="missing-if-branch" title="if path not taken" >I</span>require(msg.sender == properties[id].taxRecipient, "must be previous taxRecipient");
<span class="cstat-no" title="statement not covered" >        properties[id].taxRecipient = newRecipient</span>;
<span class="cstat-no" title="statement not covered" >        emit ChangeRecipient(id, newRecipient, msg.sender);</span>
    }
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Nov 14 2020 18:34:50 GMT-0200 (GMT-02:00)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
