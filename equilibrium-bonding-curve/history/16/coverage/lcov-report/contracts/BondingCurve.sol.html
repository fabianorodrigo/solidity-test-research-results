<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/BondingCurve.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> BondingCurve.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">38.64% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>17/44</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">21.43% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>6/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.78% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>17/45</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
&nbsp;
import "./Token.sol";
import './zeppelin/SafeMath.sol';
&nbsp;
contract BondingCurve {
&nbsp;
  using SafeMath for uint256;
&nbsp;
  Token public mToken;
&nbsp;
  struct Holder {
    address   holder;   // holder address
    uint256   ntoken;   // number of bonded token
    uint256   target;    // the target sell price
  }
  // mapping address to associated holder struct
  mapping (address =&gt; Holder) public mHolders;
  // the holder array used to find highest target sell price
  address[] public arrayHolders;
&nbsp;
  // latest sold price
  uint256 public  curSoldPrice;
&nbsp;
  // the number of remaining bonded tokens
  uint256 public  supply;
  uint256 public  initPrice;
&nbsp;
  modifier validHolder() {
    <span class="missing-if-branch" title="if path not taken" >I</span>require(mHolders[msg.sender].holder != address(0));
    _;
  }
&nbsp;
  ///////////////////////////////////////////////////////////////////
  //  Constructor function
  ///////////////////////////////////////////////////////////////////
  // 1. constructor
  constructor(address _tokenAddress) public {
      <span class="missing-if-branch" title="else path not taken" >E</span>require(_tokenAddress != address(0));
      // instantiate deployed Ocean token contract
      mToken = Token(_tokenAddress);
      // initial available supply of bonded token
      supply = 100;
      // inital price for bonded token
      initPrice = 1;
  }
&nbsp;
  function buyTokens(uint256 _ntoken, uint256 _target) public returns (bool) {
    // first check whether the holder exist, if not, create holder struct
    <span class="missing-if-branch" title="else path not taken" >E</span>if (mHolders[msg.sender].holder == address(0)){
        mHolders[msg.sender] = Holder(msg.sender, 0, 0);
        arrayHolders.push(msg.sender);
    }
&nbsp;
    // if supply is available, buy bonded token upto available balance with fixed price
    <span class="missing-if-branch" title="else path not taken" >E</span>if(supply &gt; 0) {
      uint256 amount = (_ntoken &gt; supply) ? supply : _ntoken;
      // make payment
      <span class="missing-if-branch" title="if path not taken" >I</span>require(mToken.transferFrom(msg.sender, address(this), amount.mul(initPrice)));
      // update balance
<span class="cstat-no" title="statement not covered" >      mHolders[msg.sender].ntoken = mHolders[msg.sender].ntoken.add(amount)</span>;
      // update supply
<span class="cstat-no" title="statement not covered" >      supply = supply.sub(amount)</span>;
      // update target price
<span class="cstat-no" title="statement not covered" >      mHolders[msg.sender].target = _target</span>;
    }
&nbsp;
    // if all bonded tokens are sold out, buy from another holders
    // buy the tokens with target price from the nextSeller
    // for time being, we limit the buy amount equals to balance of nextSeller
    // we will improve this to buy more in the next available sellers in the future
<span class="cstat-no" title="statement not covered" >    if(supply == 0){</span>
      // find next seller
<span class="cstat-no" title="statement not covered" >      address seller = findNextHolder();</span>
      // calculate amount of tokens to buy
<span class="cstat-no" title="statement not covered" >      uint256 num =  (_ntoken &gt; mHolders[seller].ntoken) ? mHolders[seller].ntoken : _ntoken;</span>
      // calculate cost
<span class="cstat-no" title="statement not covered" >      uint256 cost = num.mul(mHolders[seller].target);</span>
      // make payment
<span class="cstat-no" title="statement not covered" >      require(mToken.transferFrom(msg.sender, mHolders[seller].holder, cost))</span>;
      // update seller balance
<span class="cstat-no" title="statement not covered" >      mHolders[seller].ntoken = mHolders[seller].ntoken.sub(num)</span>;
      // update buyer balance
<span class="cstat-no" title="statement not covered" >      mHolders[msg.sender].ntoken = mHolders[msg.sender].ntoken.add(num)</span>;
      // there is no change in total supply
<span class="cstat-no" title="statement not covered" >      mHolders[msg.sender].target = _target</span>;
    }
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function sellTokens(uint256 amount) public validHolder returns (bool) </span>{
    // holder shall have enough bonded token to sell
<span class="cstat-no" title="statement not covered" >    require(mHolders[msg.sender].ntoken &gt;= amount)</span>;
    // calculate payout of reserved token
<span class="cstat-no" title="statement not covered" >    uint256 payout = amount.mul(initPrice);</span>
    // ensure the contract has enough reserved token to pay out
<span class="cstat-no" title="statement not covered" >    require(mToken.balanceOf(address(this)) &gt;= payout)</span>;
    // transfer reserved token to holder
<span class="cstat-no" title="statement not covered" >    require(mToken.transfer(msg.sender, payout))</span>;
    // decrease the balance of bonded token for seller
<span class="cstat-no" title="statement not covered" >    mHolders[msg.sender].ntoken = mHolders[msg.sender].ntoken.sub(amount)</span>;
    // update supply
<span class="cstat-no" title="statement not covered" >    supply = supply.add(amount)</span>;
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function changeTargetPrice(uint256 _price) public validHolder returns (bool) </span>{
    // change his target sell price
<span class="cstat-no" title="statement not covered" >    mHolders[msg.sender].target = _price</span>;
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
  // query the next available sell price
  function queryNextPrice() public view returns(uint256) {
    //check remaining supply
    <span class="missing-if-branch" title="else path not taken" >E</span>if(supply &gt; 0){
      return initPrice;
    } else <span class="cstat-no" title="statement not covered" >if (supply == 0){</span>
<span class="cstat-no" title="statement not covered" >      return mHolders[findNextHolder()].target;</span>
    }
  }
&nbsp;
&nbsp;
  function getTokenSupply() public view returns (uint256) {
    return supply;
  }
&nbsp;
  // query balance of bonded token
<span class="fstat-no" title="function not covered" >  function getTokenBalance() public view validHolder returns (uint256) </span>{
<span class="cstat-no" title="statement not covered" >    return mHolders[msg.sender].ntoken;</span>
  }
&nbsp;
  function findNextHolder() internal view returns(address) {
    uint256 maximal = 0;
    for(uint256 i; i &lt; arrayHolders.length; i++){
        // skip holders with zero token balance
<span class="cstat-no" title="statement not covered" >        if(mHolders[arrayHolders[i]].ntoken == 0){</span>
          continue;
        }
        // find the holder with highest target sell price
<span class="cstat-no" title="statement not covered" >        if(mHolders[arrayHolders[i]].target &gt; mHolders[arrayHolders[maximal]].target){</span>
<span class="cstat-no" title="statement not covered" >            maximal = i</span>;
        }
    }
&nbsp;
    return mHolders[arrayHolders[maximal]].holder;
  }
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Nov 11 2020 16:12:55 GMT-0200 (GMT-02:00)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
